# RGB-Light-Master

## 功能概述
使用stm32单片机及一些其他的模块，实现了对RGB彩灯的多种操作，同时为了美化外观，制做了一个rtc时钟。

## 硬件配置
- `stm32f103c8t6` 单片机一个
- `esp8266` WIFI模块一个
- RGB彩灯一个
- `DHT11` 温湿度传感器一个
- 声音传感器一个
- OLED屏幕一个
- `CR2032` 电池座&电池一个
- 按钮7个
- 100Ω电位器一个

## 按键定义
* PA12按键：`↑`
* PA15按键：`OK`
* PA11按键：`↓`
* PB14按键：`+`
* PB15按键：`-`
* PB13按键：`设置`
* PB11按键：`切换/退出`
* 具体接法在`.ioc`文件中
* 具体PCB板`.epro`文件中

## 实现的功能
#### 1. RTC时钟（扩展功能）
将单片机接入电源，开启单片机，等待初始化后即可看到RTC时钟，会在屏幕上显示日期、时间、星期，并且在连接电池后，可以实现掉电走时。设置时钟方法：长按`设置`进入设置界面，使用`↓`按键切换需要设置的项目，再使用`+`、`-`进行设置，长按`设置`保存并退出。
#### 2.菜单（扩展功能）
在RTC时钟界面，长按`切换/退出`按键进入菜单界面，一共有两页，提供了8种模式与WiFi，Game选项，使用`↑`、`↓`进行选择，长按`OK`进入该项。
#### 3.按键点灯
在菜单界面若选择`Mode1`，则进入按键点灯模式，共有三个子模式，使用`切换/退出`进行切换，三个子模式的操作根据屏幕上的提示即可。
#### 4.周期灯
在菜单界面若选择`Mode2`，则进入按键周期灯模式，设置周期方法：长按`设置`进入设置界面，使用`切换/退出`按键切换需要设置的项目，再使用`+`、`-`进行设置，长按`设置`保存并退出。退出模式时，长按`切换/退出`。
#### 5.呼吸灯
在菜单界面若选择`Mode3`，则进入按键呼吸灯模式，设置周期方法：长按`设置`进入设置界面，使用`切换/退出`按键切换需要设置的项目，再使用`+`、`-`进行设置，长按`设置`保存并退出。退出模式时，长按`切换/退出`。
#### 6.可调亮度灯
在菜单界面若选择`Mode4`，则进入按键可调亮度灯模式，设置亮度方法：使用`+`、`-`进行设置。退出模式时，长按`切换/退出`。
#### 7.电压指示灯
在菜单界面若选择`Mode5`，则进入按键电压指示灯模式，设置周期方法：长按`设置`进入设置界面，再使用`+`、`-`进行设置，长按`设置`保存并退出。退出模式时，长按`切换/退出`。
#### 8.温度指示灯
在菜单界面若选择`Mode6`，则进入按键温度指示灯模式，设置周期方法：长按`设置`进入设置界面，再使用`+`、`-`进行设置，长按`设置`保存并退出。退出模式时，长按`切换/退出`。
#### 9.声音指示灯
在菜单界面若选择`Mode7`，则进入按键声音指示灯模式，响度越大，灯越亮。
#### 10.RGB灯
在菜单界面若选择`Mode8`，则进入按键RGB灯模式，设置周期方法：长按`设置`进入设置界面，使用`切换/退出`按键切换需要设置的项目，再使用`+`、`-`进行设置，长按`设置`保存并退出。退出模式时，长按`切换/退出`。
#### 11.WIFI
初始化过程后，会创建名为`OOPS`的WIFI,密码为`12345678`，可以进行连接，在菜单界面若选择`WIFI`，进入WIFI模式，此时可以使用`<mode1>`、`<mode2>`等进入各种模式，在各种模式的界面以`<switch>`替换`切换`按键，以`<exit>`替换`退出`按键，以`<+>/<->`替换`+/-`按键，以`<set>`替换`设置`按键，且在各种设置界面可以使用`<%d>`（如`<256>`）的形式来改变值。
#### 12.Flappy Bird（扩展功能）
在菜单界面若选择`Game`，进入Flappy Bird，使用`OK`完成各种操作，在结束界面出现时，长按`OK`开始下一局，长按`切换/退出`退出。
#### 13.秒表（扩展功能）
在菜单界面若选择`Timer`，进入秒表，短按`OK`开始计时/暂停，短按`设置`复位，长按`切换/退出`退出。

## 实现原理
#### 1. RTC时钟（扩展功能）
使用`time.h`自带的tm结构体管理时间，并且自己写了一个rtc库用于创建并设置时间，同时绕过了自带的初始化函数内容，使之在按下`reset`按键时能够不间断工作。使用了备份寄存器用来避免重复初始化，实现掉电走时。（参考了一个网上的[教程](https://docs.baud-dance.com/docs/stm32/example/Misc_RTC/#%E4%BE%8B%E7%A8%8B%E8%AE%B2%E8%A7%A3 "教程的网址")）
#### 2.按键点灯
前两个子模式下，循环检测按键的状态，并根据不同状态设置pwm中的compare值，控制灯的亮灭，第三个子模式下，创建状态参数`pin0_status`来控制灯的亮灭（按下按键会改变变量的值从而可以控制灯）
#### 3.周期灯
使用`HAL_GetTick`函数获得时间，减去上一个周期末尾的时间，如果大于设定值就亮灯。
#### 4.呼吸灯
将pwm的compare值循环设置为1-100之间的数字，从而实现呼吸灯，设置不同的周期则可以在每次设置compare值后加上一个延时，延时越长周期越大，延时函数传入的值为一个变量时，就可以设置周期了。
#### 5.可调亮度灯
通过按下按键设置compare值，可以改变亮度。
#### 6.电压指示灯
使用分压接法接入一个电位器，并且用单片机自带的ADC读入检测值，经过计算可以得到分得的电压，公式如下:

![公式](https://latex.codecogs.com/svg.latex?\frac{ADC}{4095}*100=Value)

当Voltage可变时，检测的电压可变。
#### 7.温度指示灯
从`DHT11`读取温湿度数据，并与设定值进行比较。
#### 8.声音指示灯
从ADC读取麦克风数据，并用此公式转化为100以内的数：

![公式](https://latex.codecogs.com/svg.latex?\frac{ADC}{4095}*100=Value)

转化完成后，将compare值设置为Value即可。
#### 9.RGB灯
将三个灯的compare值设置为一个数时，可以任意调整颜色。
#### 10.WIFI
将`esp8266`设置为AP模式后，根据接收到的数据进行对应的操作，具体参考了网上的[教程](https://blog.csdn.net/qq_62078460/article/details/128355821)
## 待改进的问题
- [ ] 按键点灯模式过多调用`OLED_Clear`函数导致屏幕闪烁的问题
- [ ] 菜单不支持循环
- [ ] 界面UI美化问题
- [ ] 呼吸灯模式下周期过长时退出按键检测的问题
- [ ] 长按与短按检测时屏幕更新停滞的问题
## 可能的更新
- [ ] 加入几个游戏...
